

```python
import sqlite3
from flask import Flask, request, jsonify, g

app = Flask(__name__)
DATABASE = 'shop.db'


def get_db():
    if 'db' not in g:
        g.db = sqlite3.connect(DATABASE)
        g.db.row_factory = sqlite3.Row
    return g.db


@app.teardown_appcontext
def close_db(exception):
    db = g.pop('db', None)
    if db is not None:
        db.close()


def init_db():
    db = sqlite3.connect(DATABASE)
    db.row_factory = sqlite3.Row
    db.execute("PRAGMA foreign_keys = ON")

    db.executescript("""
        CREATE TABLE IF NOT EXISTS products (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL UNIQUE,
            price REAL NOT NULL CHECK(price >= 0),
            stock INTEGER NOT NULL DEFAULT 0 CHECK(stock >= 0)
        );

        CREATE TABLE IF NOT EXISTS discount_codes (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            code TEXT NOT NULL UNIQUE,
            percentage REAL NOT NULL CHECK(percentage > 0 AND percentage <= 100),
            active INTEGER NOT NULL DEFAULT 1
        );

        CREATE TABLE IF NOT EXISTS cart_items (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            session_id TEXT NOT NULL,
            product_id INTEGER NOT NULL,
            quantity INTEGER NOT NULL CHECK(quantity > 0),
            FOREIGN KEY (product_id) REFERENCES products(id),
            UNIQUE(session_id, product_id)
        );

        CREATE TABLE IF NOT EXISTS orders (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            session_id TEXT NOT NULL,
            discount_code TEXT,
            discount_percentage REAL DEFAULT 0,
            subtotal REAL NOT NULL,
            total REAL NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );

        CREATE TABLE IF NOT EXISTS order_items (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            order_id INTEGER NOT NULL,
            product_id INTEGER NOT NULL,
            product_name TEXT NOT NULL,
            price REAL NOT NULL,
            quantity INTEGER NOT NULL,
            FOREIGN KEY (order_id) REFERENCES orders(id),
            FOREIGN KEY (product_id) REFERENCES products(id)
        );
    """)

    # Seed sample data if empty
    cursor = db.execute("SELECT COUNT(*) as cnt FROM products")
    if cursor.fetchone()['cnt'] == 0:
        db.executemany(
            "INSERT INTO products (name, price, stock) VALUES (?, ?, ?)",
            [
                ("Laptop", 999.99, 10),
                ("Mouse", 29.99, 50),
                ("Keyboard", 79.99, 30),
                ("Monitor", 399.99, 15),
                ("Headphones", 149.99, 25),
            ]
        )

    cursor = db.execute("SELECT COUNT(*) as cnt FROM discount_codes")
    if cursor.fetchone()['cnt'] == 0:
        db.executemany(
            "INSERT INTO discount_codes (code, percentage, active) VALUES (?, ?, ?)",
            [
                ("SAVE10", 10.0, 1),
                ("SAVE20", 20.0, 1),
                ("HALF", 50.0, 1),
                ("EXPIRED5", 5.0, 0),
            ]
        )

    db.commit()
    db.close()


def get_session_id():
    """Get session ID from header or default."""
    return request.headers.get('X-Session-ID', 'default-session')


@app.route('/products', methods=['GET'])
def list_products():
    db = get_db()
    products = db.execute("SELECT id, name, price, stock FROM products").fetchall()
    return jsonify({
        "products": [dict(p) for p in products]
    }), 200


@app.route('/cart/add', methods=['POST'])
def add_to_cart():
    data = request.get_json()
    if not data:
        return jsonify({"error": "Request body must be JSON"}), 400

    product_id = data.get('product_id')
    quantity = data.get('quantity', 1)

    if product_id is None:
        return jsonify({"error": "product_id is required"}), 400

    if not isinstance(quantity, int) or quantity < 1:
        return jsonify({"error": "quantity must be a positive integer"}), 400

    session_id = get_session_id()
    db = get_db()

    product = db.execute(
        "SELECT id, name, price, stock FROM products WHERE id = ?",
        (product_id,)
    ).fetchone()

    if not product:
        return jsonify({"error": "Product not found"}), 404

    # Check existing cart quantity for this product
    existing = db.execute(
        "SELECT quantity FROM cart_items WHERE session_id = ? AND product_id = ?",
        (session_id, product_id)
    ).fetchone()

    current_qty = existing['quantity'] if existing else 0
    new_qty = current_qty + quantity

    if new_qty > product['stock']:
        return jsonify({
            "error": f"Insufficient stock. Available: {product['stock']}, in cart: {current_qty}, requested: {quantity}"
        }), 400

    if existing:
        db.execute(
            "UPDATE cart_items SET quantity = ? WHERE session_id = ? AND product_id = ?",
            (new_qty, session_id, product_id)
        )
    else:
        db.execute(
            "INSERT INTO cart_items (session_id, product_id, quantity) VALUES (?, ?, ?)",
            (session_id, product_id, quantity)
        )

    db.commit()

    return jsonify({
        "message": f"Added {quantity} x {product['name']} to cart",
        "product": {
            "id": product['id'],
            "name": product['name'],
            "price": product['price'],
        },
        "quantity_in_cart": new_qty
    }), 200


@app.route('/cart', methods=['GET'])
def view_cart():
    session_id = get_session_id()
    db = get_db()

    items = db.execute("""
        SELECT ci.id, ci.product_id, p.name, p.price, ci.quantity,
               (p.price * ci.quantity) as line_total
        FROM cart_items ci
        JOIN products p ON ci.product_id = p.id
        WHERE ci.session_id = ?
    """, (session_id,)).fetchall()

    cart_items = [dict(item) for item in items]
    subtotal = sum(item['line_total'] for item in cart_items)

    return jsonify({
        "session_id": session_id,
        "items": cart_items,
        "subtotal": round(subtotal, 2),
        "item_count": sum(item['quantity'] for item in cart_items)
    }), 200


@app.route('/cart/remove', methods=['POST'])
def remove_from_cart():
    data = request.get_json()
    if not data:
        return jsonify({"error": "Request body must be JSON"}), 400

    product_id = data.get('product_id')
    quantity = data.get('quantity')  # None means remove all

    if product_id is None:
        return jsonify({"error": "product_id is required"}), 400

    session_id = get_session_id()
    db = get_db()

    existing = db.execute(
        "SELECT quantity FROM cart_items WHERE session_id = ? AND product_id = ?",
        (session_id, product_id)
    ).fetchone()

    if not existing:
        return jsonify({"error": "Item not in cart"}), 404

    if quantity is None or quantity >= existing['quantity']:
        db.execute(
            "DELETE FROM cart_items WHERE session_id = ? AND product_id = ?",
            (session_id, product_id)
        )
        message = "Item removed from cart"
    else:
        if not isinstance(quantity, int) or quantity < 1:
            return jsonify({"error": "quantity must be a positive integer"}), 400
        new_qty = existing['quantity'] - quantity
        db.execute(
            "UPDATE cart_items SET quantity = ? WHERE session_id = ? AND product_id = ?",
            (new_qty, session_id, product_id)
        )
        message = f"Reduced quantity by {quantity}"

    db.commit()
    return jsonify({"message": message}), 200


@app.route('/cart/checkout', methods=['POST'])
def checkout():
    session_id = get_session_id()
    db = get_db()

    data = request.get_json() or {}
    discount_code = data.get('discount_code')

    # Get cart items
    items = db.execute("""
        SELECT ci.product_id, p.name, p.price, ci.quantity, p.stock,
               (p.price * ci.quantity) as line_total
        FROM cart_items ci
        JOIN products p ON ci.product_id = p.id
        WHERE ci.session_id = ?
    """, (session_id,)).fetchall()

    if not items:
        return jsonify({"error": "Cart is empty"}), 400

    # Verify stock availability
    for item in items:
        if item['quantity'] > item['stock']:
            return jsonify({
                "error": f"Insufficient stock for {item['name']}. Available: {item['stock']}, requested: {item['quantity']}"
            }), 400

    subtotal = sum(item['line_total'] for item in items)
    discount_percentage = 0.0
    applied_code = None

    # Validate discount code
    if discount_code:
        discount = db.execute(
            "SELECT code, percentage, active FROM discount_codes WHERE code = ?",
            (discount_code,)
        ).fetchone()

        if not discount:
            return jsonify({"error": f"Discount code '{discount_code}' not found"}), 400

        if not discount['active']:
            return jsonify({"error": f"Discount code '{discount_code}' is no longer active"}), 400

        discount_percentage = discount['percentage']
        applied_code = discount['code']

    discount_amount = round(subtotal * (discount_percentage / 100), 2)
    total = round(subtotal - discount_amount, 2)

    # Create order
    cursor = db.execute(
        """INSERT INTO orders (session_id, discount_code, discount_percentage, subtotal, total)
           VALUES (?, ?, ?, ?, ?)""",
        (session_id, applied_code, discount_percentage, round(subtotal, 2), total)
    )
    order_id = cursor.lastrowid

    # Create order items and update stock
    for item in items:
        db.execute(
            """INSERT INTO order_items (order_id, product_id, product_name, price, quantity)
               VALUES (?, ?, ?, ?, ?)""",
            (order_id, item['product_id'], item['name'], item['price'], item['quantity'])
        )
        db.execute(
            "UPDATE products SET stock = stock - ? WHERE id = ?",
            (item['quantity'], item['product_id'])
        )

    # Clear cart
    db.execute("DELETE FROM cart_items WHERE session_id = ?", (session_id,))
    db.commit()

    order_items = [{
        "product_id": item['product_id'],
        "name": item['name'],
        "price": item['price'],
        "quantity": item['quantity'],
        "line_total": round(item['line_total'], 2)
    } for item in items]

    response = {
        "message": "Order placed successfully",
        "order": {
            "order_id": order_id,
            "items": order_items,
            "subtotal": round(subtotal, 2),
            "discount": {
                "code": applied_code,
                "percentage": discount_percentage,
                "amount": discount_amount
            } if applied_code else None,
            "total": total
        }
    }

    return jsonify(response), 201


@app.route('/orders', methods=['GET'])
def list_orders():
    session_id = get_session_id()
    db = get_db()

    orders = db.execute(
        """SELECT id, discount_code, discount_percentage, subtotal, total, created_at
           FROM orders WHERE session_id = ? ORDER BY created_at DESC""",
        (session_id,)
    ).fetchall()

    result = []
    for order in orders:
        order_items = db.execute(
            """SELECT product_id, product_name, price, quantity, (price * quantity) as line_total
               FROM order_items WHERE order_id = ?""",
            (order['id'],)
        ).fetchall()

        result.append({
            "order_id": order['id'],
            "items": [dict(oi) for oi in order_items],
            "discount_code": order['discount_code'],
            "discount_percentage": order['discount_percentage'],
            "subtotal": order['subtotal'],
            "total": order['total'],
            "created_at": order['created_at']
        })

    return jsonify({"orders": result}), 200


@app.route('/discount-codes', methods=['GET'])
def list_discount_codes():
    db = get_db()
    codes = db.execute(
        "SELECT code, percentage, active FROM discount_codes WHERE active = 1"
    ).fetchall()
    return jsonify({"discount_codes": [dict(c) for c in codes]}), 200


if __name__ == '__main__':
    init_db()
    app.run(debug=True, port=5000)
```