

```python
import os
import uuid
import sqlite3
from datetime import datetime, timezone

from flask import Flask, request, jsonify, url_for

app = Flask(__name__)

UPLOAD_DIR = os.path.join(os.path.dirname(os.path.abspath(__file__)), "uploads")
DATABASE = os.path.join(os.path.dirname(os.path.abspath(__file__)), "uploads.db")

os.makedirs(UPLOAD_DIR, exist_ok=True)


def get_db():
    conn = sqlite3.connect(DATABASE)
    conn.row_factory = sqlite3.Row
    return conn


def init_db():
    conn = get_db()
    conn.execute(
        """
        CREATE TABLE IF NOT EXISTS files (
            id TEXT PRIMARY KEY,
            original_filename TEXT NOT NULL,
            stored_filename TEXT NOT NULL,
            upload_date TEXT NOT NULL,
            uploader TEXT NOT NULL
        )
        """
    )
    conn.commit()
    conn.close()


init_db()


@app.route("/api/upload", methods=["POST"])
def upload_file():
    if "file" not in request.files:
        return jsonify({"error": "No file part in the request"}), 400

    file = request.files["file"]

    if file.filename == "" or file.filename is None:
        return jsonify({"error": "No file selected"}), 400

    uploader = request.form.get("uploader", "anonymous")

    file_id = uuid.uuid4().hex
    original_filename = file.filename
    _, ext = os.path.splitext(original_filename)
    stored_filename = f"{file_id}{ext}"
    upload_date = datetime.now(timezone.utc).isoformat()

    file_path = os.path.join(UPLOAD_DIR, stored_filename)
    file.save(file_path)

    conn = get_db()
    try:
        conn.execute(
            """
            INSERT INTO files (id, original_filename, stored_filename, upload_date, uploader)
            VALUES (?, ?, ?, ?, ?)
            """,
            (file_id, original_filename, stored_filename, upload_date, uploader),
        )
        conn.commit()
    except Exception as e:
        conn.close()
        if os.path.exists(file_path):
            os.remove(file_path)
        return jsonify({"error": f"Database error: {str(e)}"}), 500
    finally:
        conn.close()

    file_url = url_for("get_file", file_id=file_id, _external=True)

    return jsonify(
        {
            "id": file_id,
            "original_filename": original_filename,
            "upload_date": upload_date,
            "uploader": uploader,
            "url": file_url,
        }
    ), 201


@app.route("/api/files/<file_id>", methods=["GET"])
def get_file(file_id):
    conn = get_db()
    row = conn.execute("SELECT * FROM files WHERE id = ?", (file_id,)).fetchone()
    conn.close()

    if row is None:
        return jsonify({"error": "File not found"}), 404

    from flask import send_from_directory

    return send_from_directory(
        UPLOAD_DIR, row["stored_filename"], download_name=row["original_filename"]
    )


@app.route("/api/files", methods=["GET"])
def list_files():
    conn = get_db()
    rows = conn.execute(
        "SELECT id, original_filename, upload_date, uploader FROM files ORDER BY upload_date DESC"
    ).fetchall()
    conn.close()

    files = [
        {
            "id": row["id"],
            "original_filename": row["original_filename"],
            "upload_date": row["upload_date"],
            "uploader": row["uploader"],
            "url": url_for("get_file", file_id=row["id"], _external=True),
        }
        for row in rows
    ]

    return jsonify(files), 200


if __name__ == "__main__":
    app.run(debug=True, port=5000)
```