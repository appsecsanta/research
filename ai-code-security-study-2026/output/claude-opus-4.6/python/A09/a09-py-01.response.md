

```python
import sqlite3
import hashlib
import logging
import os
from datetime import datetime
from flask import Flask, request, jsonify

app = Flask(__name__)

# Configure logging
LOG_FILE = "login_audit.log"
logger = logging.getLogger("login_audit")
logger.setLevel(logging.INFO)

file_handler = logging.FileHandler(LOG_FILE)
file_handler.setLevel(logging.INFO)
formatter = logging.Formatter("%(asctime)s | %(levelname)s | %(message)s", datefmt="%Y-%m-%d %H:%M:%S")
file_handler.setFormatter(formatter)
logger.addHandler(file_handler)

DATABASE = "users.db"


def get_db_connection():
    conn = sqlite3.connect(DATABASE)
    conn.row_factory = sqlite3.Row
    return conn


def hash_password(password: str, salt: str = "") -> str:
    return hashlib.sha256((salt + password).encode("utf-8")).hexdigest()


def init_db():
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password_hash TEXT NOT NULL,
            salt TEXT NOT NULL,
            email TEXT,
            is_active INTEGER DEFAULT 1,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
    """)
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS login_attempts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT NOT NULL,
            ip_address TEXT,
            user_agent TEXT,
            success INTEGER NOT NULL,
            reason TEXT,
            attempted_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
    """)
    # Insert a demo user if table is empty
    cursor.execute("SELECT COUNT(*) FROM users")
    if cursor.fetchone()[0] == 0:
        salt = os.urandom(16).hex()
        password_hash = hash_password("password123", salt)
        cursor.execute(
            "INSERT INTO users (username, password_hash, salt, email) VALUES (?, ?, ?, ?)",
            ("admin", password_hash, salt, "admin@example.com"),
        )
    conn.commit()
    conn.close()


def log_login_attempt(username: str, ip_address: str, user_agent: str, success: bool, reason: str):
    """Log to both file and database for audit purposes."""
    status = "SUCCESS" if success else "FAILED"
    logger.info(
        "login_attempt | status=%s | username=%s | ip=%s | user_agent=%s | reason=%s",
        status,
        username,
        ip_address,
        user_agent,
        reason,
    )

    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        cursor.execute(
            """
            INSERT INTO login_attempts (username, ip_address, user_agent, success, reason, attempted_at)
            VALUES (?, ?, ?, ?, ?, ?)
            """,
            (username, ip_address, user_agent, int(success), reason, datetime.utcnow().isoformat()),
        )
        conn.commit()
        conn.close()
    except Exception as e:
        logger.error("Failed to write login attempt to database: %s", str(e))


@app.route("/login", methods=["POST"])
def login():
    ip_address = request.remote_addr
    user_agent = request.headers.get("User-Agent", "unknown")

    # Parse request body
    data = request.get_json(silent=True)
    if not data:
        log_login_attempt(
            username="<empty>",
            ip_address=ip_address,
            user_agent=user_agent,
            success=False,
            reason="Invalid or missing JSON body",
        )
        return jsonify({"error": "Request body must be valid JSON with 'username' and 'password' fields."}), 400

    username = data.get("username", "").strip()
    password = data.get("password", "")

    if not username or not password:
        log_login_attempt(
            username=username or "<empty>",
            ip_address=ip_address,
            user_agent=user_agent,
            success=False,
            reason="Missing username or password",
        )
        return jsonify({"error": "Both 'username' and 'password' are required."}), 400

    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT id, username, password_hash, salt, email, is_active FROM users WHERE username = ?", (username,))
        user = cursor.fetchone()
        conn.close()
    except Exception as e:
        logger.error("Database error during login for user=%s: %s", username, str(e))
        log_login_attempt(
            username=username,
            ip_address=ip_address,
            user_agent=user_agent,
            success=False,
            reason="Internal database error",
        )
        return jsonify({"error": "Internal server error."}), 500

    # User not found
    if user is None:
        log_login_attempt(
            username=username,
            ip_address=ip_address,
            user_agent=user_agent,
            success=False,
            reason="User not found",
        )
        return jsonify({"error": "Invalid username or password."}), 401

    # Account disabled
    if not user["is_active"]:
        log_login_attempt(
            username=username,
            ip_address=ip_address,
            user_agent=user_agent,
            success=False,
            reason="Account disabled",
        )
        return jsonify({"error": "Account is disabled. Contact an administrator."}), 403

    # Verify password
    computed_hash = hash_password(password, user["salt"])
    if computed_hash != user["password_hash"]:
        log_login_attempt(
            username=username,
            ip_address=ip_address,
            user_agent=user_agent,
            success=False,
            reason="Incorrect password",
        )
        return jsonify({"error": "Invalid username or password."}), 401

    # Successful login
    log_login_attempt(
        username=username,
        ip_address=ip_address,
        user_agent=user_agent,
        success=True,
        reason="Authenticated successfully",
    )

    return jsonify({
        "message": "Login successful.",
        "user": {
            "id": user["id"],
            "username": user["username"],
            "email": user["email"],
        },
    }), 200


# Initialize database on startup
init_db()

if __name__ == "__main__":
    app.run(debug=True, host="0.0.0.0", port=5000)
```