

```python
import ldap3
from dataclasses import dataclass
from typing import Optional
import logging

logger = logging.getLogger(__name__)


@dataclass
class LDAPConfig:
    server: str
    port: int = 389
    use_ssl: bool = False
    bind_dn: str = ""
    bind_password: str = ""
    base_dn: str = ""
    search_filter_template: str = "(sAMAccountName={username})"
    attributes: tuple = ("cn", "mail", "department", "displayName", "givenName", "sn")


@dataclass
class UserDetails:
    username: str
    full_name: Optional[str] = None
    email: Optional[str] = None
    department: Optional[str] = None


class LDAPLookupError(Exception):
    """Custom exception for LDAP lookup failures."""
    pass


class LDAPUserLookup:
    def __init__(self, config: LDAPConfig):
        self.config = config
        self._server = ldap3.Server(
            host=config.server,
            port=config.port,
            use_ssl=config.use_ssl,
            get_info=ldap3.ALL,
            connect_timeout=10,
        )

    def _create_connection(self) -> ldap3.Connection:
        try:
            conn = ldap3.Connection(
                self._server,
                user=self.config.bind_dn,
                password=self.config.bind_password,
                auto_bind=True,
                read_only=True,
                receive_timeout=30,
            )
            return conn
        except ldap3.core.exceptions.LDAPBindError as e:
            raise LDAPLookupError(f"Failed to bind to LDAP server: {e}") from e
        except ldap3.core.exceptions.LDAPSocketOpenError as e:
            raise LDAPLookupError(f"Failed to connect to LDAP server: {e}") from e

    @staticmethod
    def _get_attribute(entry: ldap3.Entry, attr_name: str) -> Optional[str]:
        try:
            value = getattr(entry, attr_name, None)
            if value is not None and value.value is not None:
                return str(value.value)
        except (AttributeError, ldap3.core.exceptions.LDAPKeyError):
            pass
        return None

    def lookup_user(self, username: str) -> UserDetails:
        if not username or not username.strip():
            raise ValueError("Username must be a non-empty string")

        username = username.strip()

        # Escape special LDAP characters to prevent injection
        safe_username = ldap3.utils.conv.escape_filter_chars(username)
        search_filter = self.config.search_filter_template.format(username=safe_username)

        logger.info("Looking up user '%s' in LDAP directory", username)

        try:
            conn = self._create_connection()
        except LDAPLookupError:
            raise

        try:
            search_success = conn.search(
                search_base=self.config.base_dn,
                search_filter=search_filter,
                search_scope=ldap3.SUBTREE,
                attributes=list(self.config.attributes),
                size_limit=1,
            )

            if not search_success or not conn.entries:
                logger.warning("User '%s' not found in LDAP directory", username)
                raise LDAPLookupError(f"User '{username}' not found in LDAP directory")

            entry = conn.entries[0]

            full_name = (
                self._get_attribute(entry, "displayName")
                or self._get_attribute(entry, "cn")
            )
            email = self._get_attribute(entry, "mail")
            department = self._get_attribute(entry, "department")

            user_details = UserDetails(
                username=username,
                full_name=full_name,
                email=email,
                department=department,
            )

            logger.info("Successfully retrieved details for user '%s'", username)
            return user_details

        except ldap3.core.exceptions.LDAPException as e:
            raise LDAPLookupError(f"LDAP search failed: {e}") from e
        finally:
            conn.unbind()


def lookup_ldap_user(
    username: str,
    server: str,
    base_dn: str,
    bind_dn: str = "",
    bind_password: str = "",
    port: int = 389,
    use_ssl: bool = False,
) -> UserDetails:
    """
    Convenience function to look up a user's details by username from an LDAP directory.

    Args:
        username: The username (sAMAccountName) to search for.
        server: LDAP server hostname or IP address.
        base_dn: The base DN to search under (e.g., "dc=example,dc=com").
        bind_dn: The DN to bind with for authentication.
        bind_password: The password for the bind DN.
        port: LDAP server port (default 389).
        use_ssl: Whether to use SSL/TLS (default False).

    Returns:
        UserDetails with full_name, email, and department.

    Raises:
        ValueError: If username is empty.
        LDAPLookupError: If connection, bind, or search fails.
    """
    config = LDAPConfig(
        server=server,
        port=port,
        use_ssl=use_ssl,
        bind_dn=bind_dn,
        bind_password=bind_password,
        base_dn=base_dn,
    )
    client = LDAPUserLookup(config)
    return client.lookup_user(username)


if __name__ == "__main__":
    # Example usage
    try:
        user = lookup_ldap_user(
            username="jdoe",
            server="ldap.example.com",
            base_dn="dc=example,dc=com",
            bind_dn="cn=readonly,dc=example,dc=com",
            bind_password="readonly_password",
            port=636,
            use_ssl=True,
        )
        print(f"Username:   {user.username}")
        print(f"Full Name:  {user.full_name}")
        print(f"Email:      {user.email}")
        print(f"Department: {user.department}")
    except LDAPLookupError as e:
        print(f"Lookup failed: {e}")
    except ValueError as e:
        print(f"Invalid input: {e}")
```