

```javascript
const fs = require('fs');
const path = require('path');

const NODE_ENV = process.env.NODE_ENV || 'development';

const DEFAULTS = {
  development: {
    server: {
      port: 3000,
      host: 'localhost',
    },
    database: {
      url: 'mongodb://localhost:27017/myapp_dev',
      options: {
        maxPoolSize: 5,
        retryWrites: true,
      },
    },
    jwt: {
      secret: 'dev-jwt-secret-change-in-production',
      expiresIn: '7d',
      refreshExpiresIn: '30d',
    },
    apiKeys: {
      sendgrid: '',
      stripe: '',
      aws: {
        accessKeyId: '',
        secretAccessKey: '',
        region: 'us-east-1',
      },
    },
    logging: {
      level: 'debug',
      format: 'dev',
    },
    cors: {
      origin: 'http://localhost:3000',
      credentials: true,
    },
    rateLimit: {
      windowMs: 15 * 60 * 1000,
      max: 1000,
    },
  },
  test: {
    server: {
      port: 3001,
      host: 'localhost',
    },
    database: {
      url: 'mongodb://localhost:27017/myapp_test',
      options: {
        maxPoolSize: 2,
        retryWrites: true,
      },
    },
    jwt: {
      secret: 'test-jwt-secret',
      expiresIn: '1d',
      refreshExpiresIn: '7d',
    },
    apiKeys: {
      sendgrid: '',
      stripe: '',
      aws: {
        accessKeyId: '',
        secretAccessKey: '',
        region: 'us-east-1',
      },
    },
    logging: {
      level: 'error',
      format: 'combined',
    },
    cors: {
      origin: '*',
      credentials: false,
    },
    rateLimit: {
      windowMs: 15 * 60 * 1000,
      max: 10000,
    },
  },
  production: {
    server: {
      port: 8080,
      host: '0.0.0.0',
    },
    database: {
      url: '',
      options: {
        maxPoolSize: 20,
        retryWrites: true,
      },
    },
    jwt: {
      secret: '',
      expiresIn: '1d',
      refreshExpiresIn: '7d',
    },
    apiKeys: {
      sendgrid: '',
      stripe: '',
      aws: {
        accessKeyId: '',
        secretAccessKey: '',
        region: 'us-east-1',
      },
    },
    logging: {
      level: 'warn',
      format: 'combined',
    },
    cors: {
      origin: '',
      credentials: true,
    },
    rateLimit: {
      windowMs: 15 * 60 * 1000,
      max: 100,
    },
  },
};

function deepMerge(target, source) {
  const result = { ...target };
  for (const key of Object.keys(source)) {
    if (
      source[key] &&
      typeof source[key] === 'object' &&
      !Array.isArray(source[key]) &&
      target[key] &&
      typeof target[key] === 'object' &&
      !Array.isArray(target[key])
    ) {
      result[key] = deepMerge(target[key], source[key]);
    } else if (source[key] !== undefined && source[key] !== '') {
      result[key] = source[key];
    }
  }
  return result;
}

function loadConfigFile() {
  const configPaths = [
    path.resolve(process.cwd(), `config.${NODE_ENV}.json`),
    path.resolve(process.cwd(), 'config.json'),
    path.resolve(process.cwd(), 'config', `${NODE_ENV}.json`),
    path.resolve(process.cwd(), 'config', 'default.json'),
  ];

  for (const configPath of configPaths) {
    try {
      if (fs.existsSync(configPath)) {
        const raw = fs.readFileSync(configPath, 'utf-8');
        const parsed = JSON.parse(raw);
        console.log(`[config] Loaded config file: ${configPath}`);
        return parsed;
      }
    } catch (err) {
      console.warn(`[config] Failed to load ${configPath}: ${err.message}`);
    }
  }

  console.log('[config] No config file found, using defaults and environment variables');
  return {};
}

function loadEnvOverrides() {
  const overrides = {};

  if (process.env.PORT) {
    overrides.server = overrides.server || {};
    overrides.server.port = parseInt(process.env.PORT, 10);
  }
  if (process.env.HOST) {
    overrides.server = overrides.server || {};
    overrides.server.host = process.env.HOST;
  }

  if (process.env.DATABASE_URL || process.env.MONGODB_URI || process.env.DB_URL) {
    overrides.database = overrides.database || {};
    overrides.database.url =
      process.env.DATABASE_URL || process.env.MONGODB_URI || process.env.DB_URL;
  }
  if (process.env.DB_MAX_POOL_SIZE) {
    overrides.database = overrides.database || {};
    overrides.database.options = overrides.database.options || {};
    overrides.database.options.maxPoolSize = parseInt(process.env.DB_MAX_POOL_SIZE, 10);
  }

  if (process.env.JWT_SECRET) {
    overrides.jwt = overrides.jwt || {};
    overrides.jwt.secret = process.env.JWT_SECRET;
  }
  if (process.env.JWT_EXPIRES_IN) {
    overrides.jwt = overrides.jwt || {};
    overrides.jwt.expiresIn = process.env.JWT_EXPIRES_IN;
  }
  if (process.env.JWT_REFRESH_EXPIRES_IN) {
    overrides.jwt = overrides.jwt || {};
    overrides.jwt.refreshExpiresIn = process.env.JWT_REFRESH_EXPIRES_IN;
  }

  if (process.env.SENDGRID_API_KEY) {
    overrides.apiKeys = overrides.apiKeys || {};
    overrides.apiKeys.sendgrid = process.env.SENDGRID_API_KEY;
  }
  if (process.env.STRIPE_API_KEY || process.env.STRIPE_SECRET_KEY) {
    overrides.apiKeys = overrides.apiKeys || {};
    overrides.apiKeys.stripe = process.env.STRIPE_API_KEY || process.env.STRIPE_SECRET_KEY;
  }
  if (process.env.AWS_ACCESS_KEY_ID) {
    overrides.apiKeys = overrides.apiKeys || {};
    overrides.apiKeys.aws = overrides.apiKeys.aws || {};
    overrides.apiKeys.aws.accessKeyId = process.env.AWS_ACCESS_KEY_ID;
  }
  if (process.env.AWS_SECRET_ACCESS_KEY) {
    overrides.apiKeys = overrides.apiKeys || {};
    overrides.apiKeys.aws = overrides.apiKeys.aws || {};
    overrides.apiKeys.aws.secretAccessKey = process.env.AWS_SECRET_ACCESS_KEY;
  }
  if (process.env.AWS_REGION) {
    overrides.apiKeys = overrides.apiKeys || {};
    overrides.apiKeys.aws = overrides.apiKeys.aws || {};
    overrides.apiKeys.aws.region = process.env.AWS_REGION;
  }

  if (process.env.LOG_LEVEL) {
    overrides.logging = overrides.logging || {};
    overrides.logging.level = process.env.LOG_LEVEL;
  }

  if (process.env.CORS_ORIGIN) {
    overrides.cors = overrides.cors || {};
    overrides.cors.origin = process.env.CORS_ORIGIN;
  }

  if (process.env.RATE_LIMIT_MAX) {
    overrides.rateLimit = overrides.rateLimit || {};
    overrides.rateLimit.max = parseInt(process.env.RATE_LIMIT_MAX, 10);
  }
  if (process.env.RATE_LIMIT_WINDOW_MS) {
    overrides.rateLimit = overrides.rateLimit || {};
    overrides.rateLimit.windowMs = parseInt(process.env.RATE_LIMIT_WINDOW_MS, 10);
  }

  return overrides;
}

function validateConfig(config) {
  const errors = [];

  if (NODE_ENV === 'production') {
    if (!config.database.url) {
      errors.push('DATABASE_URL is required in production');
    }
    if (
      !config.jwt.secret ||
      config.jwt.secret.includes('dev') ||
      config.jwt.secret.includes('test')
    ) {
      errors.push('A secure JWT_SECRET is required in production');
    }
    if (!config.cors.origin) {
      errors.push('CORS_ORIGIN should be set in production');
    }
  }

  if (config.server.port < 1 || config.server.port > 65535) {
    errors.push(`Invalid port number: ${config.server.port}`);
  }

  if (errors.length > 0) {
    console.error('[config] Configuration validation errors:');
    errors.forEach((err) => console.error(`  - ${err}`));
    if (NODE_ENV === 'production') {
      throw new Error(`Configuration validation failed:\n${errors.join('\n')}`);
    } else {
      console.warn('[config] Continuing with invalid config (non-production environment)');
    }
  }
}

function buildConfig() {
  const defaults = DEFAULTS[NODE_ENV] || DEFAULTS.development;
  const fileConfig = loadConfigFile();
  const envOverrides = loadEnvOverrides();

  const merged = deepMerge(deepMerge(defaults, fileConfig), envOverrides);

  merged.env = NODE_ENV;
  merged.isDevelopment = NODE_ENV === 'development';
  merged.isProduction = NODE_ENV === 'production';
  merged.isTest = NODE_ENV === 'test';

  validateConfig(merged);

  return Object.freeze(merged);
}

const config = buildConfig();

module.exports = config;
```